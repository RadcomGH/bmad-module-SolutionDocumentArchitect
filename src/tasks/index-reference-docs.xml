<task id="_bmad/sda/tasks/index-reference-docs" name="Index Reference Docs"
  description="Generates or updates index.yaml of all reference documents with validation and change detection">
  <llm critical="true">
    <i>MANDATORY: Execute ALL steps in the flow section IN EXACT ORDER</i>
    <i>DO NOT skip steps or change the sequence</i>
    <i>HALT immediately when halt-conditions are met</i>
    <i>Each action xml tag within step xml tag is a REQUIRED action to complete that step</i>
    <i>Sections outside flow (validation, output, critical-context) provide essential context - review and apply throughout execution</i>
  </llm>

  <flow>
    <step n="1" title="Load Previous Index">
      <i>Check if {project-root}/reference-docs/index.yaml exists and load it for comparison</i>
    </step>

    <step n="2" title="Scan Reference Documents">
      <i>Recursively scan all subdirectories under {project-root}/reference-docs/</i>
      <i>List all files excluding hidden files (starting with .), the index itself, and README.md</i>
      <i>Organize by the directory structure: requirements/customer, requirements/internal, design/architecture, etc.</i>
    </step>

    <step n="3" title="Extract Metadata">
      <i>For each document:</i>
      <i>- Extract title from first heading in markdown files, or use filename for other formats</i>
      <i>- Record last modified timestamp</i>
      <i>- Store relative path from reference-docs/</i>
      <i>- Note file type/extension</i>
    </step>

    <step n="4" title="Detect Changes">
      <i>Compare with previous index (if exists):</i>
      <i>- Identify new documents</i>
      <i>- Identify removed documents</i>
      <i>- Identify modified documents (changed timestamp)</i>
    </step>

    <step n="5" title="Generate Statistics">
      <i>Calculate:</i>
      <i>- Total document count</i>
      <i>- Count by category (requirements, design, systems, solutions, context)</i>
      <i>- Count by file type</i>
    </step>

    <step n="6" title="Create/Update Index">
      <i>Write index.yaml with organized document listings following the output-format structure</i>
      <i>Include current timestamp</i>
    </step>

    <step n="7" title="Report Changes">
      <i>Output summary of:</i>
      <i>- Documents added since last index</i>
      <i>- Documents removed since last index</i>
      <i>- Documents modified since last index</i>
      <i>- Total document count</i>
    </step>
  </flow>

  <output-format>
    <example>
# Reference Documents Index
# Auto-generated by index-reference-docs task
# Last updated: 2026-02-05T12:34:56Z

index:
  requirements:
    customer:
      - path: customer/project-requirements.md
        title: Project Requirements Document
        last_modified: 2026-02-05
        type: md
    internal:
      - path: internal/tech-specs.pdf
        title: Technical Specifications
        last_modified: 2026-02-03
        type: pdf
  design:
    architecture:
      - path: architecture/system-design.md
        title: System Architecture Overview
        last_modified: 2026-02-04
        type: md
    technical: []
    decisions: []
  systems:
    current: []
    legacy: []
  solutions:
    templates: []
    archives: []
  context:
    domain: []
    business: []
    compliance: []

statistics:
  total_documents: 3
  by_category:
    requirements: 2
    design: 1
    systems: 0
    solutions: 0
    context: 0
  by_type:
    md: 2
    pdf: 1
  last_scan: 2026-02-05T12:34:56Z
    </example>
  </output-format>

  <halt-conditions critical="true">
    <i>HALT if {project-root}/reference-docs/ directory does not exist</i>
    <i>HALT if user does not have write permissions to create index.yaml</i>
  </halt-conditions>

  <validation>
    <i>Use relative paths from reference-docs/ root</i>
    <i>Preserve directory structure in index organization</i>
    <i>Read markdown file contents to extract actual title from first # heading</i>
    <i>For non-markdown files, use filename (without extension) as title</i>
    <i>Sort alphabetically within each category</i>
    <i>Skip hidden files (starting with .)</i>
    <i>Skip the index.yaml file itself</i>
    <i>Skip README.md in root reference-docs directory</i>
    <i>Record timestamps in ISO 8601 format</i>
    <i>Ensure YAML is properly formatted and valid</i>
  </validation>

  <critical-context>
    <directory-structure>
      reference-docs/
      ├── requirements/
      │   ├── customer/
      │   └── internal/
      ├── design/
      │   ├── architecture/
      │   ├── technical/
      │   └── decisions/
      ├── systems/
      │   ├── current/
      │   └── legacy/
      ├── solutions/
      │   ├── templates/
      │   └── archives/
      └── context/
          ├── domain/
          ├── business/
          └── compliance/
    </directory-structure>
    <i>This structure is created by the SDA module installer and is expected to exist</i>
    <i>The index enables agents to discover and query available reference documents programmatically</i>
  </critical-context>
</task>
