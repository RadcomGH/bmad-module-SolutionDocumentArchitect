<task id="_bmad/sda/tasks/index-reference-docs" name="Index Reference Docs"
  description="Generates or updates index.yaml of all reference documents with validation and change detection">
  <llm critical="true">
    <i>MANDATORY: Execute ALL steps in the flow section IN EXACT ORDER</i>
    <i>DO NOT skip steps or change the sequence</i>
    <i>HALT immediately when halt-conditions are met</i>
    <i>Each action xml tag within step xml tag is a REQUIRED action to complete that step</i>
    <i>Sections outside flow (validation, output, critical-context) provide essential context - review and apply throughout execution</i>
  </llm>

  <flow>
    <step n="1" title="Load Previous Index">
      <i>Check if {project-root}/reference-docs/index.yaml exists and load it for comparison</i>
    </step>

    <step n="2" title="Scan Reference Documents">
      <i>Recursively scan all subdirectories under {project-root}/reference-docs/</i>
      <i>List all files excluding hidden files (starting with .), the index itself, and README.md</i>
      <i>Organize by the directory structure: 01-context-and-requirements, 02-architecture-and-design, 03-security-and-integrations, 04-operations-and-risks, 99-archive</i>
    </step>

    <step n="3" title="Extract Metadata">
      <i>For each document:</i>
      <i>- Extract title from first heading in markdown files, or use filename for other formats</i>
      <i>- Record last modified timestamp</i>
      <i>- Store relative path from reference-docs/</i>
      <i>- Note file type/extension</i>
    </step>

    <step n="4" title="Detect Changes">
      <i>Compare with previous index (if exists):</i>
      <i>- Identify new documents</i>
      <i>- Identify removed documents</i>
      <i>- Identify modified documents (changed timestamp)</i>
    </step>

    <step n="5" title="Generate Statistics">
      <i>Calculate:</i>
      <i>- Total document count</i>
      <i>- Count by category (01-context-and-requirements, 02-architecture-and-design, 03-security-and-integrations, 04-operations-and-risks, 99-archive)</i>
      <i>- Count by file type</i>
    </step>

    <step n="6" title="Create/Update Index">
      <i>Write index.yaml with organized document listings following the output-format structure</i>
      <i>Include current timestamp</i>
    </step>

    <step n="7" title="Report Changes">
      <i>Output summary of:</i>
      <i>- Documents added since last index</i>
      <i>- Documents removed since last index</i>
      <i>- Documents modified since last index</i>
      <i>- Total document count</i>
    </step>
  </flow>

  <output-format>
    <example>
# Reference Documents Index
# Auto-generated by index-reference-docs task
# Last updated: 2026-02-05T12:34:56Z

index:
  01-context-and-requirements:
    - path: 01-context-and-requirements/project-requirements.md
      title: Project Requirements Document
      last_modified: 2026-02-05
      type: md
    - path: 01-context-and-requirements/business-context.pdf
      title: Business Context Overview
      last_modified: 2026-02-03
      type: pdf
  02-architecture-and-design:
    - path: 02-architecture-and-design/system-design.md
      title: System Architecture Overview
      last_modified: 2026-02-04
      type: md
  03-security-and-integrations: []
  04-operations-and-risks: []
  99-archive: []

statistics:
  total_documents: 3
  by_category:
    01-context-and-requirements: 2
    02-architecture-and-design: 1
    03-security-and-integrations: 0
    04-operations-and-risks: 0
    99-archive: 0
  by_type:
    md: 2
    pdf: 1
  last_scan: 2026-02-05T12:34:56Z
    </example>
  </output-format>

  <halt-conditions critical="true">
    <i>HALT if {project-root}/reference-docs/ directory does not exist</i>
    <i>HALT if user does not have write permissions to create index.yaml</i>
  </halt-conditions>

  <validation>
    <i>Use relative paths from reference-docs/ root</i>
    <i>Preserve directory structure in index organization</i>
    <i>Read markdown file contents to extract actual title from first # heading</i>
    <i>For non-markdown files, use filename (without extension) as title</i>
    <i>Sort alphabetically within each category</i>
    <i>Skip hidden files (starting with .)</i>
    <i>Skip the index.yaml file itself</i>
    <i>Skip README.md in root reference-docs directory</i>
    <i>Record timestamps in ISO 8601 format</i>
    <i>Ensure YAML is properly formatted and valid</i>
  </validation>

  <critical-context>
    <directory-structure>
      reference-docs/
      ├── 01-context-and-requirements/
      ├── 02-architecture-and-design/
      ├── 03-security-and-integrations/
      ├── 04-operations-and-risks/
      └── 99-archive/
    </directory-structure>
    <i>This structure is created by the SDA module installer and is expected to exist</i>
    <i>The index enables agents to discover and query available reference documents programmatically</i>
  </critical-context>
</task>
